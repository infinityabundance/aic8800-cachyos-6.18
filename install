#!/bin/bash

# Get the current directory dynamically
BASE_DIR=$(pwd)
FW_DIR="$BASE_DIR/fw/aic8800DC"
RULES_FILE="$BASE_DIR/aic.rules"

echo "Starting AIC8800 Driver Installation..."

# 1. Setup Udev Rules
if [ -f "$RULES_FILE" ]; then
    cp "$RULES_FILE" /etc/udev/rules.d/aic.rules
    udevadm control --reload
    udevadm trigger
    echo "Udev rules configured."
fi

# 2. Handle Firmware
echo "Copying firmware..."
mkdir -p /lib/firmware/aic8800DC
cp -rf "$FW_DIR/"* /lib/firmware/aic8800DC/

# 3. Build and Install Drivers
cd "$BASE_DIR/drivers/aic8800/"
make clean
make

if [ $? -ne 0 ]; then
    echo "Build failed. Check kernel headers."
    exit 1
fi

make install

# 4. Load Modules
echo "Loading modules..."
modprobe cfg80211
modprobe aic_load_fw 2>/dev/null || insmod "$BASE_DIR/drivers/aic8800/aic_load_fw/aic_load_fw.ko"
modprobe aic8800_fdrv 2>/dev/null || insmod "$BASE_DIR/drivers/aic8800/aic8800_fdrv/aic8800_fdrv.ko"

echo "Installation successful!"
exit 0
